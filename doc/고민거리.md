# 고민거리

## 1. 돈을 저장하기 위한 데이터 타입

### 1.1. 고 민

데이터베이스에 돈(money)을 저장하기 위한 데이터 타입으로 `DECIMAL`과 `BIGINT`를 고민중입니다.

부동소수점 방식의 데이터타입은 정확도가 중요한 돈과 같은 정보를 저장하기에는 부적절합니다.

따라서 고정소수점 방식의 `DECIMAL`을 흔히들 사용합니다.

하지만 달러와 같은 통화와 달리 한국의 원화는 소수점을 사용하지 않습니다.

### 1.2. 선 택

BIGINT 를 사용하여 처리하기로 결정했습니다.

정수형 타입으로도 충분히 원화를 저장할 수 있습니다.

## 2. 결제 데이터 양방향 매핑

### 2.1. 고 민

유저의 결제 데이터를 양방향 매핑하여 사용할까 고민중입니다.

양방향 매핑하여 List 로 관리하면 Stream 을 사용하여 필터링이 쉽습니다.

하지만 데이터가 많을 경우 모든 결제 데이터를 로드하기 때문에 성능상 좋지 못합니다.

### 2.2. 선 택

쿼리가 변경되지 않기 때문에 Repository 를 사용하여 데이터를 받아오기로 결정했습니다.

## 3. 낙관적 락, 비관적 락

### 3.1. 고 민

멀티스레딩 환경에서 유저가 소지한 금액을 변경할 때 충돌이 발생할 수 있습니다.

충돌 제어를 위해 transaction isolation level 을 serializable 로 고려하였으나,

동시 update 상황에서 데드락이 발생할 수 있어 제외합니다.

애플리케이션 단에서 @Version 을 통해 낙관적 락을 거는 방법과

DB 단에서 비관적 락을 거는 방법 두 가지를 고려하고 있습니다.

### 3.2. 선 택

비관적 락을 걸어 순차적으로 트랜잭션을 처리하기로 결정했습니다.

낙관적 락은 재시도와 관련하여 추가적인 고려가 필요합니다.
